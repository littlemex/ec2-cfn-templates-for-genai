# VMAP å‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œçµæœ


VMAP å‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ `../scripts/test_neuron_vmap.py` ã§ã™ã€‚

```
âœ… torch_neuronx successfully imported

================================================================================
 AWS Neuron vmap å¤±æ•—æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
================================================================================
[07:39:24] ğŸ” ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Neuronã§ã®Nested vmapã‚’æ¤œè¨¼ã—ã¾ã™

================================================================================
 Neuronç’°å¢ƒãƒã‚§ãƒƒã‚¯
================================================================================
[07:39:24] âœ… torch_neuronx ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.8.0.2.10.13553+1e4dd6ca
2025-10-17 07:39:24.838173: W neuron/pjrt-api/neuronpjrt.cc:1972] Use PJRT C-API 0.73 as client did not specify a PJRT C-API version
2025-Oct-17 07:39:30.0403 478555:478624 [1] int nccl_net_ofi_create_plugin(nccl_net_ofi_plugin_t**):213 CCOM WARN NET/OFI Failed to initialize sendrecv protocol
2025-Oct-17 07:39:30.0413 478555:478624 [1] int nccl_net_ofi_create_plugin(nccl_net_ofi_plugin_t**):354 CCOM WARN NET/OFI aws-ofi-nccl initialization failed
2025-Oct-17 07:39:30.0422 478555:478624 [1] ncclResult_t nccl_net_ofi_init_no_atexit_fini_v6(ncclDebugLogger_t):183 CCOM WARN NET/OFI Initializing plugin failed
2025-Oct-17 07:39:30.0432 478555:478624 [1] net_plugin.cc:97 CCOM WARN OFI plugin initNet() failed is EFA enabled?
[07:39:30] âœ… XLA ã‚µãƒãƒ¼ãƒˆãƒ‡ãƒã‚¤ã‚¹: ['xla:0', 'xla:1']
[07:39:30] âœ… XLA ãƒ‡ãƒã‚¤ã‚¹ç¨®åˆ¥: NC_v2
[07:39:30] âœ… Neuron ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : trn1
[07:39:30] âš ï¸ Neuronãƒ‡ãƒã‚¤ã‚¹ãªã—
__main__: Neuronãƒ‡ãƒã‚¤ã‚¹ãªã—
[07:39:30] âœ… neuron-ls ã‚³ãƒãƒ³ãƒ‰æˆåŠŸ
/work/test.py:470: DeprecationWarning: Use torch_xla.device instead
  device = xm.xla_device()
[07:39:30] âœ… XLAãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–æˆåŠŸ: xla:0
[07:39:30] ğŸ” ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹XLAãƒ‡ãƒã‚¤ã‚¹: ['xla:0', 'xla:1']
[07:39:30] ğŸ” XLAãƒ‡ãƒã‚¤ã‚¹ç¨®åˆ¥: NC_v2
[07:39:30] ğŸ” Neuronãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : trn1
[07:39:30] âœ… âœ… NeuronXç’°å¢ƒã§å®Ÿéš›ã®vmapã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’æ¤œè¨¼ã—ã¾ã™
[07:39:30] ğŸ” ä½¿ç”¨ãƒ‡ãƒã‚¤ã‚¹: xla:0
[07:39:30] ğŸ” ãƒ†ã‚¹ãƒˆ1: å˜ä¸€vmap

================================================================================
 å˜ä¸€vmap ãƒ†ã‚¹ãƒˆ
================================================================================
[07:39:30] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ
[07:39:30] ğŸ” ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å½¢çŠ¶: torch.Size([32, 10])
[07:39:30] ğŸ” å˜ä¸€vmapã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é–‹å§‹...
/work/test.py:280: DeprecationWarning: Use torch_xla.sync instead
  xm.mark_step()
2025-10-17 07:39:30.000474:  478555  INFO ||NEURON_CC_WRAPPER||: Using a cached neff at /var/tmp/neuron-compile-cache/neuronxcc-2.21.18209.0+043b1bf7/MODULE_6431493834373381678+e30acd3a/model.neff
[07:39:30] ğŸ” NeuronXåŒæœŸå®Œäº†
[07:39:31] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ
[07:39:31] âœ… å˜ä¸€vmapæˆåŠŸ - å®Ÿè¡Œæ™‚é–“: 0.018ç§’
[07:39:31] ğŸ” å‡ºåŠ›å½¢çŠ¶: torch.Size([32, 5])
[07:39:31] ğŸ” ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ: {'duration_seconds': 1, 'cpu_max_percent': 2.5, 'memory_max_mb': 3196.82421875, 'process_memory_max_mb': 1038.01953125, 'total_samples': 1}
[07:39:31] ğŸ” ãƒ†ã‚¹ãƒˆ2: ãƒã‚¹ãƒˆã—ãŸvmap

================================================================================
 ãƒã‚¹ãƒˆã—ãŸvmap ãƒ†ã‚¹ãƒˆ
================================================================================
[07:39:31] ğŸ” âš ï¸  è­¦å‘Š: ã“ã®ãƒ†ã‚¹ãƒˆã¯æœ€å¤§60ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã™
[07:39:31] ğŸ” ãƒ‡ãƒ¼ã‚¿å½¢çŠ¶: [4, 8, 10]
[07:39:31] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ
[07:39:31] ğŸ” ãƒã‚¹ãƒˆã—ãŸvmapæ§‹é€ ã‚’æ§‹ç¯‰ä¸­...
[07:39:31] ğŸ” ãƒã‚¹ãƒˆã—ãŸvmapã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é–‹å§‹...
[07:39:31] ğŸ” å¤–å´vmap - ãƒãƒƒãƒå½¢çŠ¶: torch.Size([8, 10])
[07:39:31] ğŸ” å†…å´vmap - ã‚µãƒ³ãƒ—ãƒ«å½¢çŠ¶: torch.Size([10])
/work/test.py:342: DeprecationWarning: Use torch_xla.sync instead
  xm.mark_step()
2025-10-17 07:39:31.000490:  478555  INFO ||NEURON_CC_WRAPPER||: Using a cached neff at /var/tmp/neuron-compile-cache/neuronxcc-2.21.18209.0+043b1bf7/MODULE_12918015898290422879+e30acd3a/model.neff
[07:39:31] ğŸ” NeuronXåŒæœŸå®Œäº†
[07:39:32] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ
[07:39:32] âœ… ãƒã‚¹ãƒˆã—ãŸvmapæˆåŠŸ - å®Ÿè¡Œæ™‚é–“: 0.015ç§’
[07:39:32] ğŸ” å‡ºåŠ›å½¢çŠ¶: torch.Size([4, 8, 5])
[07:39:32] ğŸ” ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ: {'duration_seconds': 1, 'cpu_max_percent': 1.2, 'memory_max_mb': 3205.23046875, 'process_memory_max_mb': 1046.51953125, 'total_samples': 1}
[07:39:32] ğŸ” ãƒ†ã‚¹ãƒˆ3: æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ—

================================================================================
 æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ—ä»£æ›¿æ¡ˆãƒ†ã‚¹ãƒˆ
================================================================================
[07:39:32] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ
[07:39:32] ğŸ” ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å½¢çŠ¶: torch.Size([4, 8, 10])
[07:39:32] ğŸ” æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œé–‹å§‹...
[07:39:33] ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ
[07:39:33] âœ… æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ—æˆåŠŸ - å®Ÿè¡Œæ™‚é–“: 0.008ç§’
[07:39:33] ğŸ” å‡ºåŠ›å½¢çŠ¶: torch.Size([4, 8, 5])
[07:39:33] ğŸ” ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ: {'duration_seconds': 1, 'cpu_max_percent': 1.3, 'memory_max_mb': 3205.6953125, 'process_memory_max_mb': 1048.26953125, 'total_samples': 1}

================================================================================
 ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
================================================================================
[07:39:33] ğŸ” single_vmap: âœ… æˆåŠŸ (0.018ç§’)
[07:39:33] ğŸ”   å‡ºåŠ›å½¢çŠ¶: torch.Size([32, 5])
[07:39:33] ğŸ”   æœ€å¤§ãƒ¡ãƒ¢ãƒª: 1038.0MB
[07:39:33] ğŸ” nested_vmap: âœ… æˆåŠŸ (0.015ç§’)
[07:39:33] ğŸ”   å‡ºåŠ›å½¢çŠ¶: torch.Size([4, 8, 5])
[07:39:33] ğŸ”   æœ€å¤§ãƒ¡ãƒ¢ãƒª: 1046.5MB
[07:39:33] ğŸ” explicit_loop: âœ… æˆåŠŸ (0.008ç§’)
[07:39:33] ğŸ”   å‡ºåŠ›å½¢çŠ¶: torch.Size([4, 8, 5])
[07:39:33] ğŸ”   æœ€å¤§ãƒ¡ãƒ¢ãƒª: 1048.3MB

================================================================================
 æ¨å¥¨äº‹é …
================================================================================
[07:39:33] ğŸ” âœ… å˜ä¸€vmap: å…¨ç’°å¢ƒã§ä½¿ç”¨å¯èƒ½
[07:39:33] ğŸ” âœ… æ˜ç¤ºçš„ãƒ«ãƒ¼ãƒ—: Neuronæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
nrtucode: internal error: 54 object(s) leaked, improper teardown
```